---
title: "Teal Desiderata"
author: "Adrian Waddell"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Teal Desiderata}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


This is a list of possible directions to continue the teal development.

# Abstract FiteredData Class

Currently `teal` implements a filtering model that is useful to for clinical
trials data only as it requires an `ASL` dataset and that every dataset has the
`USUBJID` and `STUDYID` variables. Please read the
`10_teal_design_and_implementation` vignette for more details.

The required work is to make the `FilteredData` class abstract and create
concrete classes for particular data models:

```{r echo=FALSE}
knitr::include_graphics('./images/design_FilteredData.png')
```

Note that this also requires to turn the filter panel (which is shown on the
left hand side in teal app) into a shiny module that dispatches based on the
concrete class inheriring from `FilteredData`.


# Modularize Teal

Currently teal needs to be a toplevel shiny app, i.e.

```{r eval = FALSE}
library(teal)

x <- teal::init(...)

shinyApp(x$ui, x$server)
```

It would be great if we could modularize teal itself so that it can be
integrated (possibly multiple times) into another enclosing shiny app. For
example:

```{r eval=FALSE}
library(teal)

teal_instance <- teal::init_as_module(...)

ui <- fluidPage(
  titlePanel("Giant App That Uses teal only in one Frame"),

  sidebarLayout(
    sidebarPanel("sidebar panel"),
    mainPanel(
      "main panel",
      teal_instance$ui(id = "teal_1")
    )
  )
)

server <- function(input, output, session) {
  # own code and then
  callModule(module = teal_instance$server, id = "teal_1")
}

shinyApp(ui, server)
```

This way we could use multiple instances of teal with possibly different data
and data models in one overarching app.

# Save and Share State

It would be nice to implement a "Share" or a "Bookmark" button that saves the
current state of a teal app (which data was loaded, filters set, encoding
settings, etc...) so that an analysis state can be shared.

# Improve Variable Browser

Currently the `tm_variable_browser` is very basic. The univariate visualization
of the data can be improved (and abtracted). For example,

 * Make a better summary of factor variables with many factor levels
 * Provide multiple selection for bivariate plots

# Improve the Data Table View

The `tm_data_table` module could also need some more basic raw data interaction
features. Right now we only allow for frequency counts of unique rows.

 * The dataset selection needs some `CSS` styling

# Split View

Currently only one teal module can be shown at any given time (without manually
chaning the `ui` object that is returned by `teal::init`). Since it is not
possible to start the same shiny app twice it would hence be nice to find a
good solution to have two outputs side-by side (with their encoding panels).

# Framework For Logging and Analysis Guidance

If we were to share an interactive analysis environment with a health authority
it would be good to guide (and restrict) them with the analysis that they can
make with that app. Although this can be currently done there is no nice
framework to do this.

Also it would be good to have a concise logging that shows what which
stakeholder has analyzed (e.g. if a teal app is shared with affiliates).

# Class System For Teal Modules

Right now it is not possible to extend an existing teal module without modifying
that module (e.g. by adding arguments). For example for the `tm_scatterplot`
molude one might be interested to add a regression line or a loess smother on
top of the points. It would be great to design a teal module system that would
allow something like this:


```{r eval=FALSE}
my_new_module <- Class(expands = "tm_scatterplot",
                       ui = {
                         x <- parent()
                         tagList(
                           h1("new stuff"),
                           x
                         )
                       },
                       server = {
                         s <- parent()
                         # modify parent reactive expressions
                         output$plot <- reactive({
                           gg <- s$plot

                           gg + geom_smoot()
                         })
                       }
                       )
```

# Module Interdependencies

Currently all implemented teal modules are completely independent. However it
would be nice to have global states, e.g. the `ASL` variable with the study arm
information. This probably won't require huge changes (modules need to
optionally accept reactive values as arguments), but I have not done it so far.

# Code Reproducibility

We have now three prposed ways to do get reprodicuble code:

1. Doug's way with parsing all the involved code and turn reative endpoints to
ordinary function call (still need to work on that pull-request). This is a
general solution that does not require the module developper to do anything.

1. Capturing analysis code and the substitute and stack the code manually to
match the analysis. It would be nice to implement `nameExpression(name,
expression)` which captures analysis code in a transparent way.

1. Delegate the analysis to essentially a function call and have the encoding
panel only affect the arguments. E.g.


The important part here is that there is a clean distinction what teal does and
what the teal module developer has to do. For example, for the following code:

```{r eval=FALSE}
library(survival)

## Attributes to the datasets that are passed to the init data argument
ASL <- read_bce('/opt/BIOSTAT/qa/i9999/libraries/asl.sas7bdat')
ATE <- read_bce('/opt/BIOSTAT/qa/i9999/libraries/ate.sas7bdat')

## Filter Panel
ASL_f <- ASL %>% filter(SEX == 'F')
ATE_filtered <- merge(ASL_f, ATE, by = c("USUBJID", "STUDYID"))


## Teal Module Developer Resposibility (Encoding & Ouptput)
ANL <- ATE_filtered %>%
          filter(ITTFL == 'Y', PARAMCD == 'OS')

p <- p_km(
  formula = Surv(AVAL, !CNSR) ~ ARM + strata(ECOG, BAGE),
  data = ANL
)
```

Also note that the reproducible code should not depend on teal.

# Filter Labels and Fiter States

For clinical trials it is custom in Roche/Genetech to define labels that relate
to certain subsets of the patients. It would be good to extend the filter panel
(right hand side, not in the encoding panel) to facility filter labels, standard
filter configuratrions and reset to standard filter configurations.

Note that a standard filter configuration is supported when initializing the
teal app, however it's not possible to reset to that standard filter state.

# Data Extraction Widget

As clinical trials data is often in a vertical form is is often neccessary to do
the following operartion in order to get to a particular measure for each
patient:

```{r eval=FALSE}
RAW_DATA %>%
  filter(PARAM == "aaa", ZA == "bbb") %>%
  select(AVAL)
```

That is, the filtering is necessary to get to one value of interest per patient
and the select is necessary to specify the column where the values are stored.
It would be great to create an abtracted filter/select shiny module that provides an
intuitive user interface for this. I can extend on this problem if necessary.

# More Standard General Teal Modules

Currently teal comes with the following standard modules:

* variable browser
* data table viewer
* scatterplot
* crosstable
* (I started the scatterplot matrix)

It would be nice to extend the catalogue of very general modules. Specialized
modules (kaplan meier plot, time to event analysis, etc.) live in other packages
such as `teal.modules.clinical`.

